<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dodaj nowy obszar - BeeConnect</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Open+Sans:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles/styles.css">
    <script src="scripts/auth.js"></script>
    <style>
        .checkbox-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            background: #f9f9f9;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #eee;
        }
        .checkbox-label {
            display: flex;
            align-items: center;
            font-size: 13px;
            cursor: pointer;
        }
        .color-dot {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            margin-left: 5px;
        }

        /* Style dla galerii zdjęć (identyczne jak w add-product) */
        .image-preview-container {
            flex-direction: column;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .preview-gallery {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
            width: 100%;
            min-height: 120px;
            background: #f9f9f9;
            padding: 10px;
            border-radius: 4px;
            border: 1px dashed #ddd;
        }

        .preview-item {
            position: relative;
            width: 80px;
            height: 80px;
            border-radius: 4px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .preview-item .remove-btn {
            position: absolute;
            top: 2px;
            right: 2px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 10px;
            color: #dc3545;
            transition: all 0.2s;
        }

        .preview-item .remove-btn:hover {
            background: #dc3545;
            color: white;
        }

        .empty-preview {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #aaa;
            padding: 20px 0;
        }

        .image-upload-controls {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 10px;
        }
    </style>
</head>
<body>

<div class="header">
    <div class="logo-container">
        <div class="logo">
            <a href="home.html">
                <img src="assets/BeeConnect.png" alt="BeeConnect Logo">
            </a>
        </div>
        <div class="page-title">Dodaj nowy obszar</div>
    </div>
    <button class="btn back-btn" onclick="history.back()">
        <i class="fas fa-arrow-left"></i> Powrót
    </button>
</div>

<div class="main-container">
    <div class="map-container">
        <div class="instructions">
            <h4>Jak dodać nowy obszar:</h4>
            <p><span class="step">Krok 1:</span> Kliknij na mapie, aby umieścić pierwszy róg obszaru.</p>
            <p><span class="step">Krok 2:</span> Umieść pozostałe 3 punkty, aby utworzyć czworokąt.</p>
            <p><span class="step">Krok 3:</span> Dodaj zdjęcia i wybierz pożytki w formularzu.</p>
            <p><span class="step">Krok 4:</span> Kliknij "Zapisz obszar".</p>
        </div>

        <div id="map"></div>

        <button class="btn btn-danger reset-btn" id="resetBtn" style="display: none; position: absolute; bottom: 20px; left: 20px; z-index: 1000;">
            <i class="fas fa-trash"></i> Wyczyść punkty
        </button>

        <div class="status-bar" id="statusBar">
            Kliknij na mapie, aby umieścić pierwszy punkt
        </div>
    </div>

    <div class="sidebar">
        <h3><i class="fas fa-info-circle"></i> Informacje o obszarze</h3>
        <form id="areaForm">
            <div class="form-group">
                <label>Zdjęcia obszaru:</label>
                <div class="image-preview-container">
                    <div class="preview-gallery" id="preview-gallery">
                        <div class="empty-preview">
                            <i class="fas fa-camera" style="font-size: 24px; margin-bottom: 5px;"></i>
                            <span style="font-size: 12px;">Brak zdjęć</span>
                        </div>
                    </div>

                    <div class="image-upload-controls">
                        <label for="area-images" class="btn btn-outline" style="width: 100%; text-align: center; justify-content: center;">
                            <i class="fas fa-upload"></i> Wybierz zdjęcia
                        </label>
                        <input type="file" id="area-images" name="images" accept="image/*" multiple style="display: none;">
                    </div>
                    <small style="display: block; margin-top: 5px; color: #777; font-size: 11px;">Możesz dodać wiele zdjęć. Format JPG/PNG.</small>
                </div>
            </div>

            <div class="form-group">
                <label>Nazwa obszaru:</label>
                <input type="text" id="areaName" placeholder="Np. Łąka pod lasem" required>
            </div>

            <div class="form-group">
                <label>Dostępne pożytki (kwiaty):</label>
                <div class="checkbox-grid" id="flowersContainer">
                </div>
            </div>

            <div class="form-group">
                <label for="area">Powierzchnia (ha):</label>
                <input type="number" id="area" min="0.1" step="0.1" required readonly>
                <small>Ta wartość zostanie obliczona po narysowaniu obszaru</small>
            </div>
            <div class="form-group">
                <label for="description">Opis (opcjonalny):</label>
                <textarea id="description"></textarea>
            </div>
            <div class="form-group">
                <label for="maxHives">Maksymalna ilość uli:</label>
                <input type="number" id="maxHives" min="1" required>
            </div>
            <div class="form-group">
                <label for="pricePerDay">Cena za ul / dzień (zł):</label>
                <input type="number" id="pricePerDay" min="1" step="0.5" required>
            </div>
            <button type="submit" class="btn btn-accent submit-btn" id="saveBtn" disabled>
                <i class="fas fa-save"></i> Zapisz obszar
            </button>
        </form>
    </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
    // --- Stałe ---
    const API_BASE = 'http://localhost:8080';
    const PREDEFINED_FLOWERS = [
        { name: "Lipa", color: "#FF0000" },
        { name: "Wielokwiat", color: "#FFA500" },
        { name: "Gryka", color: "#FFFF00" },
        { name: "Rzepak", color: "#FFFF99" },
        { name: "Spadź", color: "#800000" },
        { name: "Akacja", color: "#7878FF" },
        { name: "Wrzos", color: "#800080" },
        { name: "Malina", color: "#FF69B4" }
    ];

    // --- Stan zdjęć ---
    let selectedFiles = [];

    // --- Inicjalizacja formularza kwiatów ---
    const flowersContainer = document.getElementById('flowersContainer');
    PREDEFINED_FLOWERS.forEach(flower => {
        const div = document.createElement('div');
        div.innerHTML = `
            <label class="checkbox-label">
                <input type="checkbox" name="flowers" value="${flower.name}">
                <span class="color-dot" style="background-color: ${flower.color}"></span>
                ${flower.name}
            </label>
        `;
        flowersContainer.appendChild(div);
    });

    // --- Inicjalizacja mapy ---
    var map = L.map('map', {
        zoomControl: false,
        attributionControl: false
    }).setView([52.237049, 21.017532], 7);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '' }).addTo(map);

    var points = [];
    var markers = [];
    var polygon = null;
    var drawing = true;

    var statusBar = document.getElementById('statusBar');
    var resetBtn = document.getElementById('resetBtn');
    var saveBtn = document.getElementById('saveBtn');
    var areaInput = document.getElementById('area');

    // --- Obsługa zdjęć ---
    document.getElementById('area-images').addEventListener('change', function(e) {
        const files = Array.from(e.target.files);

        files.forEach(file => {
            // Unikaj duplikatów
            if (!selectedFiles.some(f => f.name === file.name && f.size === file.size)) {
                selectedFiles.push(file);
            }
        });

        updateImagePreview();
        this.value = ''; // Reset inputa
    });

    function updateImagePreview() {
        const gallery = document.getElementById('preview-gallery');
        gallery.innerHTML = '';

        if (selectedFiles.length === 0) {
            gallery.innerHTML = `
                <div class="empty-preview">
                    <i class="fas fa-camera" style="font-size: 24px; margin-bottom: 5px;"></i>
                    <span style="font-size: 12px;">Brak zdjęć</span>
                </div>
            `;
            return;
        }

        selectedFiles.forEach((file, index) => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const item = document.createElement('div');
                item.className = 'preview-item';
                item.innerHTML = `
                    <img src="${e.target.result}" alt="Preview">
                    <div class="remove-btn" onclick="removeFile(${index})" title="Usuń">
                        <i class="fas fa-times"></i>
                    </div>
                `;
                gallery.appendChild(item);
            };
            reader.readAsDataURL(file);
        });
    }

    window.removeFile = function(index) {
        selectedFiles.splice(index, 1);
        updateImagePreview();
    };

    function filesToBase64List(files) {
        return Promise.all(files.map(file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => {
                const base64String = reader.result.split(',')[1];
                resolve(base64String);
            };
            reader.onerror = reject;
            reader.readAsDataURL(file);
        })));
    }

    // --- Funkcje mapy ---
    function calculateArea(points) {
        if (points.length < 3) return 0;
        var latlngs = points.map(marker => marker.getLatLng());

        // Uproszczona kalkulacja dla płaskiej powierzchni
        var areaInSquareMeters = geodesicAreaPolyfill(latlngs);
        return areaInSquareMeters / 10000; // m2 na hektary
    }

    function geodesicAreaPolyfill(latLngs) {
        var pointsCount = latLngs.length, area = 0.0;
        if (pointsCount > 2) {
            for (var i = 0; i < pointsCount; i++) {
                var p1 = latLngs[i], p2 = latLngs[(i + 1) % pointsCount];
                area += ((p2.lng - p1.lng) * Math.PI / 180) * (2 + Math.sin(p1.lat * Math.PI / 180) + Math.sin(p2.lat * Math.PI / 180));
            }
            area = area * 6378137.0 * 6378137.0 / 2.0;
        }
        return Math.abs(area);
    }

    map.on('click', function(e) {
        if (!drawing) return;

        var marker = L.marker(e.latlng).addTo(map);
        points.push(marker);
        markers.push(marker);

        var pointsLeft = 4 - points.length;
        if (pointsLeft > 0) {
            statusBar.textContent = `Umieść jeszcze ${pointsLeft} ${pointsLeft === 1 ? 'punkt' : 'punkty'}`;
        }

        if (polygon) map.removeLayer(polygon);
        var latlngs = points.map(marker => marker.getLatLng());

        if (points.length === 4) {
            polygon = L.polygon(latlngs, {color: '#8FC31F'}).addTo(map);
            drawing = false;
            statusBar.textContent = 'Obszar narysowany! Wypełnij formularz.';
            resetBtn.style.display = 'block';
            saveBtn.disabled = false;

            var area = calculateArea(points);
            areaInput.value = area.toFixed(2);
        } else if (points.length >= 2) {
            polygon = L.polyline(latlngs, {color: '#8FC31F'}).addTo(map);
        }
    });

    resetBtn.addEventListener('click', function() {
        points.forEach(marker => map.removeLayer(marker));
        if (polygon) map.removeLayer(polygon);
        points = [];
        markers = [];
        polygon = null;
        drawing = true;
        statusBar.textContent = 'Kliknij na mapie, aby umieścić pierwszy punkt';
        resetBtn.style.display = 'none';
        saveBtn.disabled = true;
        areaInput.value = '';
    });

    // --- WYSYŁANIE FORMULARZA ---
    document.getElementById('areaForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        // Zbieranie kwiatów
        const selectedFlowers = [];
        document.querySelectorAll('input[name="flowers"]:checked').forEach(cb => {
            const def = PREDEFINED_FLOWERS.find(f => f.name === cb.value);
            if(def) selectedFlowers.push(def);
        });

        if(selectedFlowers.length === 0) {
            alert("Wybierz przynajmniej jeden rodzaj pożytku (kwiaty).");
            return;
        }

        const submitBtn = document.getElementById('saveBtn');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Zapisywanie...';

        try {
            // Konwersja zdjęć
            let imagesBase64List = [];
            if (selectedFiles.length > 0) {
                imagesBase64List = await filesToBase64List(selectedFiles);
            }

            var newArea = {
                name: document.getElementById('areaName').value, // Dodano pole name
                flowers: selectedFlowers,
                coordinates: points.map(marker => [marker.getLatLng().lat, marker.getLatLng().lng]),
                area: parseFloat(document.getElementById('area').value),
                description: document.getElementById('description').value,
                maxHives: parseInt(document.getElementById('maxHives').value),
                pricePerDay: parseFloat(document.getElementById('pricePerDay').value),
                images: imagesBase64List // Wysyłanie listy zdjęć
            };

            const response = await fetch(`${API_BASE}/api/addArea`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(newArea),
                credentials: 'include'
            });

            if (response.ok) {
                alert('Obszar został dodany pomyślnie!');
                window.location.href = 'home.html';
            } else {
                const text = await response.text();
                throw new Error(text || 'Błąd serwera');
            }
        } catch(error) {
            alert('Błąd: ' + error.message);
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-save"></i> Zapisz obszar';
        }
    });
</script>
</body>
</html>