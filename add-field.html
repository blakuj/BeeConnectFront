<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dodaj nowy obszar - BeeConnect</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Open+Sans:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles/styles.css">
    <script src="scripts/auth.js"></script>
    <style>
        .checkbox-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            background: #f9f9f9;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #eee;
        }
        .checkbox-label {
            display: flex;
            align-items: center;
            font-size: 13px;
            cursor: pointer;
        }
        .color-dot {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            margin-left: 5px;
        }
    </style>
</head>
<body>

<div class="header">
    <div class="logo-container">
        <div class="logo">
            <a href="home.html">
                <img src="assets/BeeConnect.png" alt="BeeConnect Logo">
            </a>
        </div>
        <div class="page-title">Dodaj nowy obszar</div>
    </div>
    <button class="btn back-btn" onclick="history.back()">
        <i class="fas fa-arrow-left"></i> Powrót
    </button>
</div>

<div class="main-container">
    <div class="map-container">
        <div class="instructions">
            <h4>Jak dodać nowy obszar:</h4>
            <p><span class="step">Krok 1:</span> Kliknij na mapie, aby umieścić pierwszy róg obszaru.</p>
            <p><span class="step">Krok 2:</span> Umieść pozostałe 3 punkty, aby utworzyć czworokąt.</p>
            <p><span class="step">Krok 3:</span> Wybierz dostępne pożytki w formularzu.</p>
            <p><span class="step">Krok 4:</span> Kliknij "Zapisz obszar".</p>
        </div>

        <div id="map"></div>

        <button class="btn btn-danger reset-btn" id="resetBtn" style="display: none; position: absolute; bottom: 20px; left: 20px; z-index: 1000;">
            <i class="fas fa-trash"></i> Wyczyść punkty
        </button>

        <div class="status-bar" id="statusBar">
            Kliknij na mapie, aby umieścić pierwszy punkt
        </div>
    </div>

    <div class="sidebar">
        <h3><i class="fas fa-info-circle"></i> Informacje o obszarze</h3>
        <form id="areaForm">
            <div class="form-group">
                <label>Dostępne pożytki (kwiaty):</label>
                <div class="checkbox-grid" id="flowersContainer">
                </div>
            </div>

            <div class="form-group">
                <label for="area">Powierzchnia (ha):</label>
                <input type="number" id="area" min="0.1" step="0.1" required readonly>
                <small>Ta wartość zostanie obliczona po narysowaniu obszaru</small>
            </div>
            <div class="form-group">
                <label for="description">Opis (opcjonalny):</label>
                <textarea id="description"></textarea>
            </div>
            <div class="form-group">
                <label for="maxHives">Maksymalna ilość uli:</label>
                <input type="number" id="maxHives" min="1" required>
            </div>
            <div class="form-group">
                <label for="pricePerDay">Cena za ul / dzień (zł):</label>
                <input type="number" id="pricePerDay" min="1" step="0.5" required>
            </div>
            <button type="submit" class="btn btn-accent submit-btn" id="saveBtn" disabled>
                <i class="fas fa-save"></i> Zapisz obszar
            </button>
        </form>
    </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
    // --- Stałe ---
    const API_BASE = 'http://localhost:8080';
    const PREDEFINED_FLOWERS = [
        { name: "Lipa", color: "#FF0000" },
        { name: "Wielokwiat", color: "#FFA500" },
        { name: "Gryka", color: "#FFFF00" },
        { name: "Rzepak", color: "#FFFF99" },
        { name: "Spadź", color: "#800000" },
        { name: "Akacja", color: "#7878FF" },
        { name: "Wrzos", color: "#800080" },
        { name: "Malina", color: "#FF69B4" }
    ];

    // --- Inicjalizacja formularza kwiatów ---
    const flowersContainer = document.getElementById('flowersContainer');
    PREDEFINED_FLOWERS.forEach(flower => {
        const div = document.createElement('div');
        div.innerHTML = `
            <label class="checkbox-label">
                <input type="checkbox" name="flowers" value="${flower.name}">
                <span class="color-dot" style="background-color: ${flower.color}"></span>
                ${flower.name}
            </label>
        `;
        flowersContainer.appendChild(div);
    });

    // --- Inicjalizacja mapy ---
    var map = L.map('map', {
        zoomControl: false,
        attributionControl: false
    }).setView([52.237049, 21.017532], 7);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '' }).addTo(map);

    var points = [];
    var markers = [];
    var polygon = null;
    var drawing = true;

    var statusBar = document.getElementById('statusBar');
    var resetBtn = document.getElementById('resetBtn');
    var saveBtn = document.getElementById('saveBtn');
    var areaInput = document.getElementById('area');

    // --- Funkcje pomocnicze ---
    function calculateArea(points) {
        if (points.length < 3) return 0;
        var latlngs = points.map(marker => marker.getLatLng());
        var tempPolygon = L.polygon(latlngs);
        var areaInSquareMeters = L.GeometryUtil ? L.GeometryUtil.geodesicArea(tempPolygon.getLatLngs()[0]) : 0;

        // Fallback dla braku GeometryUtil (proste przybliżenie)
        if (!L.GeometryUtil) {
            // Uproszczona kalkulacja dla płaskiej powierzchni (mniej dokładna)
            // Tutaj lepiej użyć zewnętrznej biblioteki, ale dla demo wystarczy to co mamy
            // W poprzednim kodzie był polyfill, użyjmy go
            areaInSquareMeters = geodesicAreaPolyfill(latlngs);
        }

        return areaInSquareMeters / 10000;
    }

    function geodesicAreaPolyfill(latLngs) {
        var pointsCount = latLngs.length, area = 0.0;
        if (pointsCount > 2) {
            for (var i = 0; i < pointsCount; i++) {
                var p1 = latLngs[i], p2 = latLngs[(i + 1) % pointsCount];
                area += ((p2.lng - p1.lng) * Math.PI / 180) * (2 + Math.sin(p1.lat * Math.PI / 180) + Math.sin(p2.lat * Math.PI / 180));
            }
            area = area * 6378137.0 * 6378137.0 / 2.0;
        }
        return Math.abs(area);
    }

    // --- Obsługa mapy ---
    map.on('click', function(e) {
        if (!drawing) return;

        var marker = L.marker(e.latlng).addTo(map);
        points.push(marker);
        markers.push(marker);

        var pointsLeft = 4 - points.length;
        if (pointsLeft > 0) {
            statusBar.textContent = `Umieść jeszcze ${pointsLeft} ${pointsLeft === 1 ? 'punkt' : 'punkty'}`;
        }

        if (polygon) map.removeLayer(polygon);
        var latlngs = points.map(marker => marker.getLatLng());

        if (points.length === 4) {
            polygon = L.polygon(latlngs, {color: '#8FC31F'}).addTo(map);
            drawing = false;
            statusBar.textContent = 'Obszar narysowany! Wypełnij formularz.';
            resetBtn.style.display = 'block';
            saveBtn.disabled = false;

            var area = calculateArea(points);
            areaInput.value = area.toFixed(2);
        } else if (points.length >= 2) {
            polygon = L.polyline(latlngs, {color: '#8FC31F'}).addTo(map);
        }
    });

    resetBtn.addEventListener('click', function() {
        points.forEach(marker => map.removeLayer(marker));
        if (polygon) map.removeLayer(polygon);
        points = [];
        markers = [];
        polygon = null;
        drawing = true;
        statusBar.textContent = 'Kliknij na mapie, aby umieścić pierwszy punkt';
        resetBtn.style.display = 'none';
        saveBtn.disabled = true;
        areaInput.value = '';
    });

    // --- WYSYŁANIE FORMULARZA ---
    document.getElementById('areaForm').addEventListener('submit', function(e) {
        e.preventDefault();

        // Zbieranie kwiatów
        const selectedFlowers = [];
        document.querySelectorAll('input[name="flowers"]:checked').forEach(cb => {
            const def = PREDEFINED_FLOWERS.find(f => f.name === cb.value);
            if(def) selectedFlowers.push(def);
        });

        if(selectedFlowers.length === 0) {
            alert("Wybierz przynajmniej jeden rodzaj pożytku (kwiaty).");
            return;
        }

        var newArea = {
            flowers: selectedFlowers,
            coordinates: points.map(marker => [marker.getLatLng().lat, marker.getLatLng().lng]),
            area: parseFloat(document.getElementById('area').value),
            description: document.getElementById('description').value,
            maxHives: parseInt(document.getElementById('maxHives').value),
            pricePerDay: parseFloat(document.getElementById('pricePerDay').value)
        };

        fetch(`${API_BASE}/api/addArea`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(newArea),
            credentials: 'include'
        })
            .then(response => {
                if (response.ok) {
                    alert('Obszar został dodany pomyślnie!');
                    window.location.href = 'home.html';
                } else {
                    return response.text().then(text => { throw new Error(text || 'Błąd'); });
                }
            })
            .catch(error => {
                alert('Błąd: ' + error.message);
            });
    });
</script>
</body>
</html>