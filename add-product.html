<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dodaj Produkt - BeeConnect</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;600;700&family=Open+Sans:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles/styles.css">
    <style>
        /* Dodatkowe style dla galerii miniatur */
        .image-preview-container {
            flex-direction: column;
            align-items: flex-start;
        }

        .preview-gallery {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
            width: 100%;
            min-height: 150px;
            background: #f9f9f9;
            padding: 10px;
            border-radius: 4px;
            border: 1px dashed #ddd;
        }

        .preview-item {
            position: relative;
            width: 100px;
            height: 100px;
            border-radius: 4px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .preview-item .remove-btn {
            position: absolute;
            top: 2px;
            right: 2px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
            color: #dc3545;
            transition: all 0.2s;
        }

        .preview-item .remove-btn:hover {
            background: #dc3545;
            color: white;
        }

        .empty-preview {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #aaa;
        }
    </style>
</head>
<body>
<div class="header">
    <div class="logo-container">
        <div class="logo">
            <a href="home.html">
                <img src="assets/BeeConnect.png" alt="BeeConnect Logo">
            </a>
        </div>
        <div class="page-title">BeeConnect</div>
    </div>
    <div class="header-controls">
        <div class="welcome-message">Witaj, <span id="welcome-name">Użytkowniku</span>!</div>
    </div>
</div>

<div class="dashboard-container">
    <div class="dashboard-sidebar">
        <div class="user-info">
            <div class="user-avatar">
                <img src="assets/default-avatar.png" alt="Avatar użytkownika">
            </div>
            <div class="user-name" id="user-name">Ładowanie...</div>
            <div class="user-email" id="user-email">ładowanie@email.com</div>
            <div class="user-status" id="user-status">Użytkownik</div>
        </div>
        <div class="sidebar-nav">
            <a href="profile.html?tab=areas" class="sidebar-nav-item">
                <i class="fas fa-map-marked-alt"></i>
                Twoje Obszary
            </a>
            <a href="profile.html?tab=rented-areas" class="sidebar-nav-item">
                <i class="fas fa-hand-holding-heart"></i>
                Wynajęte Obszary
            </a>
            <a href="profile.html?tab=products" class="sidebar-nav-item active">
                <i class="fas fa-box"></i>
                Twoje Produkty
            </a>
            <a href="profile.html?tab=bought-products" class="sidebar-nav-item">
                <i class="fas fa-shopping-basket"></i>
                Kupione Produkty
            </a>
            <a href="edit-profile.html" class="sidebar-nav-item">
                <i class="fas fa-user-edit"></i>
                Edytuj Profil
            </a>
        </div>
        <a href="login.html" class="btn btn-outline logout-btn">
            <i class="fas fa-sign-out-alt"></i>
            Wyloguj się
        </a>
    </div>

    <div class="dashboard-content">
        <div class="dashboard-heading">
            <h1 class="dashboard-title">Dodaj Nowy Produkt</h1>
            <a class="btn btn-outline" onclick="history.back()">
                <i class="fas fa-arrow-left"></i>
                Powrót
            </a>
        </div>

        <div class="card">
            <div class="card-body">
                <form id="add-product-form">
                    <div class="form-section">
                        <h3 class="form-section-title">Zdjęcia produktu</h3>
                        <div class="form-group image-upload-top">
                            <div class="image-preview-container">
                                <div class="preview-gallery" id="preview-gallery">
                                    <div class="empty-preview">
                                        <i class="fas fa-images" style="font-size: 32px; margin-bottom: 10px;"></i>
                                        <span>Brak wybranych zdjęć</span>
                                    </div>
                                </div>

                                <div class="image-upload-controls">
                                    <label for="product-images" class="btn btn-outline image-upload-btn">
                                        <i class="fas fa-upload"></i> Wybierz zdjęcia
                                    </label>
                                    <input type="file" id="product-images" name="images" accept="image/*" multiple style="display: none;">
                                    <span class="selected-file-name" id="file-count">Nie wybrano plików</span>
                                </div>
                            </div>
                            <small class="field-info">Możesz dodać wiele zdjęć. Pierwsze zdjęcie będzie zdjęciem głównym.</small>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3 class="form-section-title">Informacje podstawowe</h3>
                        <div class="form-group">
                            <label for="product-name">Nazwa produktu*</label>
                            <input type="text" id="product-name" name="name" placeholder="Np. Miód lipowy" required>
                        </div>

                        <div class="form-group">
                            <label for="product-type">Typ produktu*</label>
                            <select id="product-type" name="type" required>
                                <option value="" disabled selected>Wybierz typ produktu</option>
                                <option value="HONEY">Miód</option>
                                <option value="POLLEN">Pyłek pszczeli</option>
                                <option value="WAX">Wosk pszczeli</option>
                                <option value="PROPOLIS">Propolis</option>
                                <option value="BEE_BREAD">Pierzga</option>
                                <option value="ROYAL_JELLY">Mleczko pszczele</option>
                                <option value="OTHER">Inny</option>
                            </select>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="product-quantity">Ilość*</label>
                                <input type="number" id="product-quantity" name="quantity" min="1" placeholder="Np. 15" required>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="product-price">Cena (PLN)*</label>
                                <input type="number" id="product-price" name="price" step="0.01" min="0" placeholder="Np. 35.00" required>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3 class="form-section-title">Informacje szczegółowe</h3>

                        <div class="form-group" id="flowers-field">
                            <label for="product-flowers">Pochodzenie kwiatowe (dla miodu)</label>
                            <input type="text" id="product-flowers" name="flowers" placeholder="Np. Lipa, Wielokwiat">
                            <small class="field-info">Oddziel różne typy kwiatów przecinkami</small>
                        </div>

                        <div class="form-group">
                            <label for="product-description">Opis produktu*</label>
                            <textarea id="product-description" name="description" rows="5" placeholder="Opisz szczegółowo swój produkt, jego właściwości i zalety..." required></textarea>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-outline" id="cancel-btn">
                            <i class="fas fa-times"></i>
                            Anuluj
                        </button>
                        <button type="submit" class="btn btn-primary" id="save-product-btn">
                            <i class="fas fa-save"></i>
                            Zapisz produkt
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    const API_URL = 'http://localhost:8080/api';

    // Tablica przechowująca wybrane pliki (Files)
    let selectedFiles = [];

    // Load user profile
    async function loadUserProfile() {
        try {
            const response = await fetch(`${API_URL}/auth/user`, {
                method: 'GET',
                credentials: 'include'
            });

            if (response.ok) {
                const user = await response.json();
                document.getElementById('user-name').textContent = `${user.firstname || ''} ${user.lastname || ''}`.trim() || 'Użytkownik';
                document.getElementById('welcome-name').textContent = user.firstname || 'Użytkowniku';
                document.getElementById('user-email').textContent = user.email || 'nieznany@email.com';
                document.getElementById('user-status').textContent = user.role === 'BEEKEEPER' ? 'Zweryfikowany Pszczelarz' : 'Użytkownik';
            } else if (response.status === 401) {
                alert('Sesja wygasła. Zaloguj się ponownie.');
                window.location.href = 'login.html';
            }
        } catch (error) {
            console.error('Błąd podczas ładowania profilu:', error);
        }
    }

    // Obsługa wyboru plików
    document.getElementById('product-images').addEventListener('change', function(e) {
        const files = Array.from(e.target.files);

        // Dodaj nowe pliki do istniejącej tablicy
        files.forEach(file => {
            // Sprawdź czy plik już nie istnieje (po nazwie i rozmiarze)
            const exists = selectedFiles.some(f => f.name === file.name && f.size === file.size);
            if (!exists) {
                selectedFiles.push(file);
            }
        });

        updateImagePreview();

        // Reset input value to allow selecting same files again if needed
        this.value = '';
    });

    function updateImagePreview() {
        const gallery = document.getElementById('preview-gallery');
        const countLabel = document.getElementById('file-count');

        gallery.innerHTML = '';

        if (selectedFiles.length === 0) {
            gallery.innerHTML = `
                <div class="empty-preview">
                    <i class="fas fa-images" style="font-size: 32px; margin-bottom: 10px;"></i>
                    <span>Brak wybranych zdjęć</span>
                </div>
            `;
            countLabel.textContent = 'Nie wybrano plików';
            return;
        }

        countLabel.textContent = `Wybrano plików: ${selectedFiles.length}`;

        selectedFiles.forEach((file, index) => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const item = document.createElement('div');
                item.className = 'preview-item';
                item.innerHTML = `
                    <img src="${e.target.result}" alt="Preview">
                    <div class="remove-btn" onclick="removeFile(${index})" title="Usuń zdjęcie">
                        <i class="fas fa-times"></i>
                    </div>
                `;
                gallery.appendChild(item);
            };
            reader.readAsDataURL(file);
        });
    }

    // Funkcja globalna, aby była dostępna z onclick w HTML
    window.removeFile = function(index) {
        selectedFiles.splice(index, 1);
        updateImagePreview();
    };

    // Helper: Konwersja wielu plików na Base64
    function filesToBase64List(files) {
        return Promise.all(files.map(file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => {
                // Usuwamy prefix "data:image/jpeg;base64," aby wysłać czysty string,
                // tak jak backend tego oczekuje w CreateProductDTO -> List<String> images
                const base64String = reader.result.split(',')[1];
                resolve(base64String);
            };
            reader.onerror = error => reject(error);
            reader.readAsDataURL(file);
        })));
    }

    // Obsługa formularza
    document.getElementById('add-product-form').addEventListener('submit', async function(e) {
        e.preventDefault();

        const submitBtn = document.getElementById('save-product-btn');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Zapisywanie...';

        try {
            // Konwersja wszystkich wybranych zdjęć
            let imagesBase64List = [];
            if (selectedFiles.length > 0) {
                imagesBase64List = await filesToBase64List(selectedFiles);
            }

            const productData = {
                name: document.getElementById('product-name').value,
                category: document.getElementById('product-type').value,
                stock: parseInt(document.getElementById('product-quantity').value),
                price: parseFloat(document.getElementById('product-price').value),
                description: document.getElementById('product-description').value,
                images: imagesBase64List // Wysyłamy listę
            };

            // Dodaj flowerOrigin tylko dla miodu (opcjonalnie, jeśli backend to obsługuje w opisie)
            if (productData.category === 'HONEY') {
                const flowers = document.getElementById('product-flowers').value;
                if (flowers) {
                    // Jeśli w DTO nie ma pola flowerOrigin, dodajemy do opisu
                    productData.description = `Pochodzenie kwiatowe: ${flowers}\n\n${productData.description}`;
                }
            }

            console.log('Wysyłanie danych produktu:', productData);

            const response = await fetch(`${API_URL}/products`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify(productData)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Błąd podczas dodawania produktu');
            }

            const result = await response.json();
            console.log('Produkt dodany:', result);

            alert('✓ Produkt został pomyślnie dodany!');
            window.location.href = 'profile.html?tab=products';

        } catch (error) {
            console.error('Błąd podczas dodawania produktu:', error);
            alert(`Nie udało się dodać produktu:\n${error.message}`);

            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-save"></i> Zapisz produkt';
        }
    });

    // Obsługa przycisku anuluj
    document.getElementById('cancel-btn').addEventListener('click', function() {
        if (confirm('Czy na pewno chcesz anulować dodawanie produktu? Wprowadzone dane zostaną utracone.')) {
            window.location.href = 'profile.html?tab=products';
        }
    });

    // Aktualizacja typu produktu w zależności od wyboru
    document.getElementById('product-type').addEventListener('change', function() {
        const flowersField = document.getElementById('flowers-field');

        // Pokaż/ukryj pole z kwiatami w zależności od typu produktu
        if (this.value === 'HONEY') {
            flowersField.style.display = 'block';
        } else {
            flowersField.style.display = 'none';
        }
    });

    // Inicjalizacja - ukryj pole kwiatów na początku
    document.getElementById('flowers-field').style.display = 'none';

    // Load user profile on page load
    window.addEventListener('DOMContentLoaded', loadUserProfile);
</script>
</body>
</html>